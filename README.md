# WebPush 通知ローカル導入手順

このディレクトリには、ローカル環境でWebプッシュ通知を実装・テストするためのコードが含まれています。

## 📁 ファイル構成

```
my-webpush/
├── README.md           # この手順書
├── package.json        # 依存関係
├── server.js          # Express サーバー（通知購読の保存）
├── send.js            # プッシュ通知送信スクリプト
├── subscription.json  # 保存された購読情報
└── public/
    ├── index.html     # フロントエンド（通知許可・購読登録）
    └── sw.js         # サービスワーカー（通知受信）
```

## 🚀 セットアップ手順

### 1. 依存関係のインストール

```bash
cd my-app/my-webpush
npm install
```

### 2. サーバーの起動

```bash
node server.js
```

サーバーが起動すると以下のメッセージが表示されます：
```
▶ http://localhost:3000 を開いてください
```

### 3. ブラウザでの通知許可・購読登録

1. ブラウザで `http://localhost:3000` を開く
2. 「通知許可 & 登録」ボタンをクリック
3. ブラウザの通知許可ダイアログで「許可」を選択
4. 「登録成功！送信スクリプトを走らせてみてください」のアラートが表示される

### 4. プッシュ通知の送信

新しいターミナルで以下のコマンドを実行：

```bash
node send.js
```

成功すると以下のメッセージが表示され、ブラウザに通知が届きます：
```
✅ Push sent
```

## 🔧 技術仕様

### 使用技術
- **サーバー**: Express.js
- **プッシュライブラリ**: web-push
- **フロントエンド**: Vanilla JavaScript + Service Worker

### VAPID キーについて
- 現在のコードには開発用のVAPIDキーがハードコーディングされています
- プロダクション環境では環境変数として管理することを推奨

### 動作の流れ

1. **サーバー起動** (`server.js`)
   - Express サーバーが3000番ポートで起動
   - `/save-sub` エンドポイントで購読情報を受信・保存
   - `public` フォルダを静的ファイルとして配信

2. **フロントエンド** (`public/index.html`)
   - サービスワーカーを登録
   - プッシュ通知の購読処理
   - 購読情報をサーバーに送信

3. **サービスワーカー** (`public/sw.js`)
   - プッシュイベントを受信
   - 通知を表示

4. **通知送信** (`send.js`)
   - 保存された購読情報を読み込み
   - web-pushライブラリを使用して通知を送信

## 🎯 カスタマイズ

### 通知メッセージの変更
`send.js` の以下の部分を編集：

```javascript
await webpush.sendNotification(sub, JSON.stringify({
  title: '作業完了👏',
  body : 'エージェントが作業を完了しました🚀'
}));
```

### 通知アイコンの変更
`public/sw.js` の以下の部分を編集：

```javascript
icon: 'https://fav.farm/🌐'
```

## ⚠️ 注意事項

- このコードは開発・テスト用です
- HTTPS環境でのみ正常に動作します（localhost除く）
- ブラウザがサービスワーカーとPush APIに対応している必要があります
- 購読情報は `subscription.json` にローカル保存されます

## 🔍 トラブルシューティング

### 通知が表示されない場合
1. ブラウザの通知設定を確認
2. サービスワーカーが正常に登録されているか確認
3. 購読情報が正常に保存されているか `subscription.json` を確認

### サーバーエラーの場合
1. ポート3000が使用されていないか確認
2. 必要な依存関係がインストールされているか確認 # web-push
